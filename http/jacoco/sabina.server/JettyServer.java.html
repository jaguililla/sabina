<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JettyServer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">http</a> &gt; <a href="index.source.html" class="el_package">sabina.server</a> &gt; <span class="el_source">JettyServer.java</span></div><h1>JettyServer.java</h1><pre class="source lang-java linenums">/*
 * Copyright Â© 2011 Per Wendel. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the
 * License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied. See the License for the specific language governing permissions
 * and limitations under the License.
 */

package sabina.server;

import static java.lang.System.exit;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.TimeUnit;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.eclipse.jetty.server.Connector;
import org.eclipse.jetty.server.Handler;
import org.eclipse.jetty.server.Request;
import org.eclipse.jetty.server.Server;
import org.eclipse.jetty.server.ServerConnector;
import org.eclipse.jetty.server.handler.HandlerList;
import org.eclipse.jetty.server.handler.ResourceHandler;
import org.eclipse.jetty.server.session.SessionHandler;
import org.eclipse.jetty.util.resource.Resource;
import org.eclipse.jetty.util.ssl.SslContextFactory;

/**
 * Simple Jetty Handler.
 *
 * @author Per Wendel
 */
class JettyHandler extends SessionHandler {
    private MatcherFilter filter;

<span class="fc" id="L47">    public JettyHandler (MatcherFilter filter) {</span>
<span class="fc" id="L48">        this.filter = filter;</span>
<span class="fc" id="L49">    }</span>

    @Override public void doHandle (
        String target,
        Request baseRequest,
        HttpServletRequest request,
        HttpServletResponse response)
        throws IOException, ServletException {

<span class="fc" id="L58">        filter.doFilter (request, response, null);</span>
<span class="fc" id="L59">        baseRequest.setHandled (filter.handled);</span>
<span class="fc" id="L60">    }</span>
}

/**
 * Sabina server backend implementation
 *
 * @author Per Wendel
 */
class JettyServer implements Backend {

    private static final String NAME = &quot;Sabina&quot;;
    private Handler handler;
    private Server server;

<span class="fc" id="L74">    public JettyServer (MatcherFilter handler) {</span>
<span class="fc" id="L75">        this.handler = new JettyHandler (handler);</span>
<span class="fc" id="L76">    }</span>

    public void startUp (
        String host, int port, String keystoreFile,
        String keystorePassword, String truststoreFile,
        String truststorePassword, String staticFilesFolder,
        String externalFilesFolder) {

        ServerConnector connector;

<span class="fc bfc" id="L86" title="All 2 branches covered.">        if (keystoreFile == null) {</span>
<span class="fc" id="L87">            connector = createSocketConnector ();</span>
        }
        else {
<span class="fc" id="L90">            connector = createSecureSocketConnector (keystoreFile,</span>
                keystorePassword, truststoreFile, truststorePassword);
        }

        // Set some timeout options to make debugging easier.
<span class="fc" id="L95">        connector.setIdleTimeout (TimeUnit.HOURS.toMillis (1));</span>
<span class="fc" id="L96">        connector.setSoLingerTime (-1);</span>
<span class="fc" id="L97">        connector.setHost (host);</span>
<span class="fc" id="L98">        connector.setPort (port);</span>

<span class="fc" id="L100">        server = connector.getServer ();</span>
<span class="fc" id="L101">        server.setConnectors (new Connector[] { connector });</span>

        // Handle static file routes
<span class="pc bpc" id="L104" title="1 of 4 branches missed.">        if (staticFilesFolder == null &amp;&amp; externalFilesFolder == null) {</span>
<span class="fc" id="L105">            server.setHandler (handler);</span>
        }
        else {
<span class="fc" id="L108">            List&lt;Handler&gt; handlersInList = new ArrayList&lt;&gt; ();</span>
<span class="fc" id="L109">            handlersInList.add (handler);</span>

            // Set static file location
<span class="fc" id="L112">            setStaticFileLocationIfPresent (staticFilesFolder, handlersInList);</span>

            // Set external static file location
<span class="fc" id="L115">            setExternalStaticFileLocationIfPresent (externalFilesFolder, handlersInList);</span>

<span class="fc" id="L117">            HandlerList handlers = new HandlerList ();</span>
<span class="fc" id="L118">            handlers</span>
<span class="fc" id="L119">                .setHandlers (handlersInList.toArray (new Handler[handlersInList.size ()]));</span>
<span class="fc" id="L120">            server.setHandler (handlers);</span>
        }

        try {
<span class="fc" id="L124">            System.out.println (&quot;=== &quot; + NAME + &quot; has ignited ...&quot;); // NOSONAR</span>
<span class="fc" id="L125">            System.out.println (&quot;&gt;&gt;&gt; Listening on &quot; + host + &quot;:&quot; + port); // NOSONAR</span>

<span class="fc" id="L127">            server.start ();</span>
<span class="fc" id="L128">            server.join ();</span>
        }
<span class="nc" id="L130">        catch (Exception e) {</span>
<span class="nc" id="L131">            e.printStackTrace (); // NOSONAR</span>
<span class="nc" id="L132">            exit (100); // NOSONAR</span>
<span class="fc" id="L133">        }</span>
<span class="fc" id="L134">    }</span>

    public void shutDown () {
<span class="fc" id="L137">        System.out.print (&quot;&gt;&gt;&gt; &quot; + NAME + &quot; shutting down...&quot;); // NOSONAR</span>
        try {
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">            if (server != null)</span>
<span class="fc" id="L140">                server.stop ();</span>
        }
<span class="nc" id="L142">        catch (Exception e) {</span>
<span class="nc" id="L143">            e.printStackTrace (); // NOSONAR</span>
<span class="nc" id="L144">            exit (100); // NOSONAR</span>
<span class="fc" id="L145">        }</span>
<span class="fc" id="L146">        System.out.println (&quot;done&quot;); // NOSONAR</span>
<span class="fc" id="L147">    }</span>

    /**
     * Creates a secure jetty socket connector. Keystore required, truststore
     * optional. If truststore not specifed keystore will be reused.
     *
     * @param keystoreFile The keystore file location as string
     * @param keystorePassword the password for the keystore
     * @param truststoreFile the truststore file location as string, leave null to reuse
     * keystore
     * @param truststorePassword the trust store password
     *
     * @return a secure socket connector
     */
    private static ServerConnector createSecureSocketConnector (
        String keystoreFile,
        String keystorePassword, String truststoreFile,
        String truststorePassword) {

<span class="fc" id="L166">        SslContextFactory sslContextFactory = new SslContextFactory (</span>
            keystoreFile);

<span class="pc bpc" id="L169" title="1 of 2 branches missed.">        if (keystorePassword != null) {</span>
<span class="fc" id="L170">            sslContextFactory.setKeyStorePassword (keystorePassword);</span>
        }
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">        if (truststoreFile != null) {</span>
<span class="nc" id="L173">            sslContextFactory.setTrustStorePath (truststoreFile);</span>
        }
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">        if (truststorePassword != null) {</span>
<span class="nc" id="L176">            sslContextFactory.setTrustStorePassword (truststorePassword);</span>
        }
<span class="fc" id="L178">        return new ServerConnector (new Server (), sslContextFactory);</span>
    }

    /**
     * Creates an ordinary, non-secured Jetty server connector.
     *
     * @return - a server connector
     */
    private static ServerConnector createSocketConnector () {
<span class="fc" id="L187">        return new ServerConnector (new Server ());</span>
    }

    /**
     * Sets static file location if present
     */
    private static void setStaticFileLocationIfPresent (
        String staticFilesRoute, List&lt;Handler&gt; handlersInList) {
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">        if (staticFilesRoute != null) {</span>
<span class="fc" id="L196">            ResourceHandler resourceHandler = new ResourceHandler ();</span>
<span class="fc" id="L197">            Resource staticResources = Resource.newClassPathResource (staticFilesRoute);</span>
<span class="fc" id="L198">            resourceHandler.setBaseResource (staticResources);</span>
<span class="fc" id="L199">            resourceHandler.setWelcomeFiles (new String[] { &quot;index.html&quot; });</span>
<span class="fc" id="L200">            handlersInList.add (resourceHandler);</span>
        }
<span class="fc" id="L202">    }</span>

    /**
     * Sets external static file location if present
     */
    private static void setExternalStaticFileLocationIfPresent (
        String externalFilesRoute, List&lt;Handler&gt; handlersInList) {
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        if (externalFilesRoute != null) {</span>
<span class="fc" id="L210">            ResourceHandler externalResourceHandler = new ResourceHandler ();</span>
<span class="fc" id="L211">            Resource externalStaticResources =</span>
<span class="fc" id="L212">                Resource.newResource (new File (externalFilesRoute));</span>
<span class="fc" id="L213">            externalResourceHandler.setBaseResource (externalStaticResources);</span>
<span class="fc" id="L214">            externalResourceHandler.setWelcomeFiles (new String[] { &quot;index.html&quot; });</span>
<span class="fc" id="L215">            handlersInList.add (externalResourceHandler);</span>
        }
<span class="fc" id="L217">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>