<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Request.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">http</a> &gt; <a href="index.source.html" class="el_package">sabina</a> &gt; <span class="el_source">Request.java</span></div><h1>Request.java</h1><pre class="source lang-java linenums">/*
 * Copyright Â© 2011 Per Wendel. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the
 * License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied. See the License for the specific language governing permissions
 * and limitations under the License.
 */

package sabina;

import static java.util.Collections.unmodifiableMap;
import static java.util.logging.Logger.getLogger;

import java.io.InputStreamReader;
import java.util.*;
import java.util.logging.Logger;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import sabina.route.RouteMatch;

/**
 * Provides information about the HTTP request
 *
 * @author Per Wendel
 */
public final class Request {
<span class="fc" id="L36">    private static final Logger LOG = getLogger(Request.class.getName ());</span>
    private static final String USER_AGENT = &quot;user-agent&quot;;

    public static Request create (
        final RouteMatch match,
        final HttpServletRequest request,
        final HttpServletResponse response) {

<span class="fc" id="L44">        return new Request (match, request, response);</span>
    }

    public static List&lt;String&gt; convertRouteToList (final String route) {
<span class="fc" id="L48">        String[] pathArray = route.split (&quot;/&quot;);</span>
<span class="fc" id="L49">        List&lt;String&gt; path = new ArrayList&lt;&gt; ();</span>
<span class="fc bfc" id="L50" title="All 2 branches covered.">        for (String p : pathArray)</span>
<span class="fc bfc" id="L51" title="All 2 branches covered.">            if (p.length () &gt; 0)</span>
<span class="fc" id="L52">                path.add (p);</span>

<span class="fc" id="L54">        return path;</span>
    }

    public final Response response;
    private final Map&lt;String, String&gt; params;
    private final List&lt;String&gt; splat;
    private final HttpServletRequest servletRequest;

    /* Lazy loaded stuff */
<span class="fc" id="L63">    private Session session = null;</span>
<span class="fc" id="L64">    private String body = null;</span>
    private Set&lt;String&gt; headers;

    //    request.media_type        # media type of request.body            DONE, content type?
    //    request[&quot;SOME_HEADER&quot;]    # value of SOME_HEADER header,          DONE
    //    request.user_agent        # user agent (used by :agent condition) DONE
    //    request.url               # &quot;http://example.com/example/foo&quot;      DONE
    //    request.ip                # client IP address                     DONE
    //    request.env               # raw env hash handed in by Rack,       DONE
    //    request.get?              # true (similar methods for other verbs)
    //    request.secure?           # false (would be true over ssl)
    //    request.forwarded?        # true (if running behind a reverse proxy)
    //    request.xhr?              # is this an ajax request?
    //    request.script_name       # &quot;/example&quot;
    //    request.form_data?        # false
    //    request.referrer          # the referrer of the client or '/'

    /**
     * Constructor.
     *
     * @param match   the route match.
     * @param request the servlet request.
     * @param response .
     */
    Request (
        final RouteMatch match,
        final HttpServletRequest request,
<span class="fc" id="L91">        final HttpServletResponse response) {</span>

<span class="fc" id="L93">        this.servletRequest = request;</span>
<span class="fc" id="L94">        this.response = new Response (response);</span>

<span class="fc" id="L96">        List&lt;String&gt; requestList = convertRouteToList (match.getRequestURI ());</span>
<span class="fc" id="L97">        List&lt;String&gt; matchedList = convertRouteToList (match.getMatchUri ());</span>

<span class="fc" id="L99">        params = getParams(requestList, matchedList);</span>
<span class="fc" id="L100">        splat = getSplat(requestList, matchedList);</span>
<span class="fc" id="L101">    }</span>

    /**
     * Returns the map containing all route params
     *
     * @return a map containing all route params
     */
    public Map&lt;String, String&gt; params () {
<span class="fc" id="L109">        return unmodifiableMap (params);</span>
    }

    /**
     * Returns the value of the provided route pattern parameter.
     * Example: parameter 'name' from the following pattern: (get '/hello/:name')
     *
     * @param param The param.
     * @return Null if the given param is null or not found.
     */
    public String params (final String param) {
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">        if (param == null)</span>
<span class="nc" id="L121">            return null;</span>

<span class="pc bpc" id="L123" title="1 of 2 branches missed.">        return param.startsWith (&quot;:&quot;)?</span>
<span class="pc" id="L124">            params.get (param.toLowerCase ()) :</span>
<span class="pc" id="L125">            params.get (&quot;:&quot; + param.toLowerCase ());</span>
    }

    /**
     * @return an array containing the splat (wildcard) parameters
     */
    public String[] splat () {
<span class="fc" id="L132">        return splat.toArray (new String[splat.size ()]);</span>
    }

    /**
     * @return request method e.g. GET, POST, PUT, ...
    //    request.request_method    # &quot;GET&quot;,                                DONE
     */
    public String requestMethod () {
<span class="fc" id="L140">        return servletRequest.getMethod ();</span>
    }

    /**
     * @return the scheme
    //    request.scheme            # &quot;http&quot;                                DONE
     */
    public String scheme () {
<span class="fc" id="L148">        return servletRequest.getScheme ();</span>
    }

    /**
     * @return the host
    //    request.host              # &quot;example.com&quot;                         DONE
     */
    public String host () {
<span class="fc" id="L156">        return servletRequest.getHeader (&quot;host&quot;);</span>
    }

    /**
     * @return the user-agent
     */
    public String userAgent () {
<span class="fc" id="L163">        return servletRequest.getHeader (USER_AGENT);</span>
    }

    /**
     * @return the server port
     */
    public int port () {
<span class="fc" id="L170">        return servletRequest.getServerPort ();</span>
    }

    /**
     * @return the path info
     * Example return: &quot;/example/foo&quot;
    //    request.path_info         # &quot;/foo&quot;,                               DONE
     */
    public String pathInfo () {
<span class="nc" id="L179">        return servletRequest.getPathInfo ();</span>
    }

    /**
     * @return the servlet path
     */
    public String servletPath () {
<span class="fc" id="L186">        return servletRequest.getServletPath ();</span>
    }

    /**
     * @return the context path
     */
    public String contextPath () {
<span class="fc" id="L193">        return servletRequest.getContextPath ();</span>
    }

    /**
     * @return the URL string
     */
    public String url () {
<span class="fc" id="L200">        return servletRequest.getRequestURL ().toString ();</span>
    }

    /**
     * @return the content type of the body
     */
    public String contentType () {
<span class="nc" id="L207">        return servletRequest.getContentType ();</span>
    }

    /**
     * @return the client's IP address
     */
    public String ip () {
<span class="fc" id="L214">        return servletRequest.getRemoteAddr ();</span>
    }

    /**
     * @return the request body sent by the client
     */
    public String body () {
<span class="pc bpc" id="L221" title="1 of 2 branches missed.">        if (body == null) {</span>
<span class="pc" id="L222">            try (InputStreamReader input =</span>
<span class="fc" id="L223">                new InputStreamReader (servletRequest.getInputStream ())) {</span>

<span class="fc" id="L225">                body = new Scanner (input).useDelimiter (&quot;\\A&quot;).next ();</span>
<span class="pc bpc" id="L226" title="6 of 8 branches missed.">            }</span>
<span class="nc" id="L227">            catch (Exception e) {</span>
<span class="nc" id="L228">                LOG.warning (&quot;Exception when reading body: &quot; + e.getMessage ());</span>
<span class="fc" id="L229">            }</span>
        }
<span class="fc" id="L231">        return body;</span>
    }

    /**
     * @return the length of request.body
    //    request.content_length    # length of request.body,               DONE
     */
    public int contentLength () {
<span class="nc" id="L239">        return servletRequest.getContentLength ();</span>
    }

    /**
     * gets the query param
     *
     * @param queryParam the query parameter
     * @return the value of the provided queryParam
     * Example: query parameter 'id' from the following request URI: /hello?id=foo
     */
    public String queryParams (String queryParam) {
<span class="fc" id="L250">        return servletRequest.getParameter (queryParam);</span>
    }

    /**
     * Gets the value for the provided header
     *
     * @param name the header
     * @return the value of the provided header
     */
    public String headers (String name) {
<span class="nc" id="L260">        return servletRequest.getHeader (name);</span>
    }

    /**
     * @return all query parameters
     */
    public Set&lt;String&gt; queryParams () {
<span class="nc" id="L267">        return servletRequest.getParameterMap ().keySet ();</span>
    }

    /**
     * @return all headers
     */
    public Set&lt;String&gt; headers () {
<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (headers == null) {</span>
<span class="nc" id="L275">            headers = new TreeSet&lt;&gt; ();</span>
<span class="nc" id="L276">            Enumeration&lt;String&gt; enumeration = servletRequest.getHeaderNames ();</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">            while (enumeration.hasMoreElements ())</span>
<span class="nc" id="L278">                headers.add (enumeration.nextElement ());</span>
        }
<span class="nc" id="L280">        return headers;</span>
    }

    /**
     * @return the query string
    //    request.query_string      # &quot;&quot;,                                   DONE
     */
    public String queryString () {
<span class="fc" id="L288">        return servletRequest.getQueryString ();</span>
    }

    /**
     * Sets an attribute on the request (can be fetched in filters/routes later in the chain)
     *
     * @param attribute The attribute
     * @param value     The attribute value
     */
    public void attribute (String attribute, Object value) {
<span class="nc" id="L298">        servletRequest.setAttribute (attribute, value);</span>
<span class="nc" id="L299">    }</span>

    /**
     * Gets the value of the provided attribute
     *
     * @param name The attribute name.
     * @return the value for the provided attribute
     */
    public Object attribute (String name) {
<span class="nc" id="L308">        return servletRequest.getAttribute (name);</span>
    }

    /**
     * @return all attributes
     */
    public Set&lt;String&gt; attributes () {
<span class="nc" id="L315">        Set&lt;String&gt; attrList = new HashSet&lt;&gt; ();</span>
<span class="nc" id="L316">        Enumeration&lt;String&gt; attributes = servletRequest.getAttributeNames ();</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">        while (attributes.hasMoreElements ())</span>
<span class="nc" id="L318">            attrList.add (attributes.nextElement ());</span>
<span class="nc" id="L319">        return attrList;</span>
    }

    /**
     * @return the raw HttpServletRequest object handed in by Jetty
     */
    public HttpServletRequest raw () {
<span class="nc" id="L326">        return servletRequest;</span>
    }

    /**
     * Returns the current session associated with this request,
     * or if the request does not have a session, creates one.
     *
     * @return the session associated with this request
     */
    public Session session () {
<span class="nc bnc" id="L336" title="All 2 branches missed.">        if (session == null)</span>
<span class="nc" id="L337">            session = new Session (servletRequest.getSession ());</span>

<span class="nc" id="L339">        return session;</span>
    }

    /**
     * Returns the current session associated with this request, or if there is
     * no current session and &lt;code&gt;create&lt;/code&gt; is true, returns  a new session.
     *
     * @param create &lt;code&gt;true&lt;/code&gt; to create a new session for this request if necessary;
     * &lt;code&gt;false&lt;/code&gt; to return null if there's no current session
     *
     * @return the session associated with this request or &lt;code&gt;null&lt;/code&gt; if
     * &lt;code&gt;create&lt;/code&gt; is &lt;code&gt;false&lt;/code&gt; and the request has no valid session
     */
    public Session session (boolean create) {
<span class="nc bnc" id="L353" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L354">            HttpSession httpSession = servletRequest.getSession (create);</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">            if (httpSession != null)</span>
<span class="nc" id="L356">                session = new Session (httpSession);</span>
        }
<span class="nc" id="L358">        return session;</span>
    }

    /**
     * @return request cookies (or empty Map if cookies dosn't present)
    //    request.cookies           # hash of browser cookies,              DONE
     */
    public Map&lt;String, String&gt; cookies () {
<span class="fc" id="L366">        Map&lt;String, String&gt; result = new HashMap&lt;&gt; ();</span>
<span class="fc" id="L367">        Cookie[] cookies = servletRequest.getCookies ();</span>
<span class="fc bfc" id="L368" title="All 2 branches covered.">        if (cookies != null)</span>
<span class="fc bfc" id="L369" title="All 2 branches covered.">            for (Cookie cookie : cookies)</span>
<span class="fc" id="L370">                result.put (cookie.getName (), cookie.getValue ());</span>

<span class="fc" id="L372">        return result;</span>
    }

    /**
     * Gets cookie by name.
     *
     * @param name name of the cookie
     *
     * @return cookie value or null if the cookie was not found
     */
    public String cookie (String name) {
<span class="fc" id="L383">        Cookie[] cookies = servletRequest.getCookies ();</span>
<span class="pc bpc" id="L384" title="1 of 2 branches missed.">        if (cookies != null)</span>
<span class="pc bpc" id="L385" title="1 of 2 branches missed.">            for (Cookie cookie : cookies)</span>
<span class="pc bpc" id="L386" title="1 of 2 branches missed.">                if (cookie.getName ().equals (name))</span>
<span class="fc" id="L387">                    return cookie.getValue ();</span>

<span class="nc" id="L389">        return null;</span>
    }

    /**
     * @return the part of this request's URL from the protocol name up to the query string in the first line of the HTTP request.
     */
    public String uri() {
<span class="fc" id="L396">        return servletRequest.getRequestURI();</span>
    }

    /**
     * @return Returns the name and version of the protocol the request uses
     */
    public String protocol() {
<span class="fc" id="L403">        return servletRequest.getProtocol();</span>
    }

    private static Map&lt;String, String&gt; getParams (List&lt;String&gt; request, List&lt;String&gt; matched) {
<span class="fc" id="L407">        LOG.fine (&quot;get params&quot;);</span>

<span class="fc" id="L409">        Map&lt;String, String&gt; params = new HashMap&lt;&gt; ();</span>

<span class="fc bfc" id="L411" title="All 4 branches covered.">        for (int i = 0; (i &lt; request.size ()) &amp;&amp; (i &lt; matched.size ()); i++) {</span>
<span class="fc" id="L412">            String matchedPart = matched.get (i);</span>
<span class="fc bfc" id="L413" title="All 2 branches covered.">            if (matchedPart.startsWith (&quot;:&quot;)) {</span>
<span class="fc" id="L414">                LOG.fine (&quot;matchedPart: &quot;</span>
                    + matchedPart
                    + &quot; = &quot;
<span class="fc" id="L417">                    + request.get (i));</span>
<span class="fc" id="L418">                params.put (matchedPart.toLowerCase (), request.get (i));</span>
            }
        }
<span class="fc" id="L421">        return unmodifiableMap (params);</span>
    }

    private static List&lt;String&gt; getSplat(List&lt;String&gt; request, List&lt;String&gt; matched) {
<span class="fc" id="L425">        LOG.fine(&quot;get splat&quot;);</span>

<span class="fc" id="L427">        int nbrOfRequestParts = request.size();</span>
<span class="fc" id="L428">        int nbrOfMatchedParts = matched.size();</span>

<span class="fc bfc" id="L430" title="All 2 branches covered.">        boolean sameLength = (nbrOfRequestParts == nbrOfMatchedParts);</span>

<span class="fc" id="L432">        List&lt;String&gt; splat = new ArrayList&lt;&gt; ();</span>

<span class="fc bfc" id="L434" title="All 4 branches covered.">        for (int i = 0; (i &lt; nbrOfRequestParts) &amp;&amp; (i &lt; nbrOfMatchedParts); i++) {</span>
<span class="fc" id="L435">            String matchedPart = matched.get(i);</span>

<span class="fc bfc" id="L437" title="All 2 branches covered.">            if (matchedPart.equals (&quot;*&quot;)) {</span>

<span class="fc" id="L439">                StringBuilder splatParam = new StringBuilder(request.get(i));</span>
<span class="pc bpc" id="L440" title="3 of 4 branches missed.">                if (!sameLength &amp;&amp; (i == (nbrOfMatchedParts - 1))) {</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">                    for (int j = i + 1; j &lt; nbrOfRequestParts; j++) {</span>
<span class="nc" id="L442">                        splatParam.append (&quot;/&quot;);</span>
<span class="nc" id="L443">                        splatParam.append (request.get (j));</span>
                    }
                }
<span class="fc" id="L446">                splat.add (splatParam.toString ());</span>
            }
        }
<span class="fc" id="L449">        return Collections.unmodifiableList (splat);</span>
    }

    /*
     * Response delegates
     */
<span class="nc" id="L455">    public void body (final String body) { response.body (body); }</span>
<span class="nc" id="L456">    public void redirect (final String location) { response.redirect (location); }</span>
<span class="nc" id="L457">    public void type (final String contentType) { response.type (contentType); }</span>
<span class="nc" id="L458">    public HttpServletResponse responseRaw () { return response.raw (); }</span>
<span class="nc" id="L459">    public String responseBody () { return response.body (); }</span>
<span class="fc" id="L460">    public void status (final int statusCode) { response.status (statusCode); }</span>
<span class="fc" id="L461">    public void removeCookie (final String name) { response.removeCookie (name); }</span>
<span class="fc" id="L462">    public void header (final String name, final String value) { response.header (name, value); }</span>
<span class="fc" id="L463">    public void cookie (final String name, final String value) { response.cookie (name, value); }</span>

    public void cookie (final String name, final String value, final int maxAge) {
<span class="nc" id="L466">        response.cookie (name, value, maxAge);</span>
<span class="nc" id="L467">    }</span>

    public void cookie (
        final String path,
        final String name,
        final String value,
        final int maxAge,
        final boolean secured) {

<span class="nc" id="L476">        response.cookie (path, name, value, maxAge, secured);</span>
<span class="nc" id="L477">    }</span>

    public void cookie (
        final String name, final String value, final int maxAge, final boolean secured) {

<span class="nc" id="L482">        response.cookie (name, value, maxAge, secured);</span>
<span class="nc" id="L483">    }</span>

    public void redirect (final String location, final int httpStatusCode) {
<span class="nc" id="L486">        response.redirect (location, httpStatusCode);</span>
<span class="nc" id="L487">    }</span>

    /**
     * Immediately stops a request within a filter or route
     * NOTE: When using this don't catch exceptions of type HaltException, or if catched,
     * re-throw otherwise halt will not work.
     */
<span class="fc" id="L494">    public void halt () { throw new HaltException (); }</span>

    /**
     * Immediately stops a request within a filter or route with specified status code
     * NOTE: When using this don't catch exceptions of type HaltException, or if catched,
     * re-throw otherwise halt will not work.
     *
     * @param status the status code.
     */
<span class="fc" id="L503">    public void halt (final int status) { throw new HaltException (status); }</span>

    /**
     * Immediately stops a request within a filter or route with specified body content
     * NOTE: When using this don't catch exceptions of type HaltException, or if catched,
     * re-throw otherwise halt will not work.
     *
     * @param body The body content.
     */
<span class="fc" id="L512">    public void halt (final String body) { throw new HaltException (body); }</span>

    /**
     * Immediately stops a request within a filter or route with specified status code and body
     * content.
     * NOTE: When using this don't catch exceptions of type HaltException, or if catched,
     * re-throw otherwise halt will not work.
     *
     * @param status The status code.
     * @param body The body content.
     */
    public void halt (final int status, final String body) {
<span class="fc" id="L524">        throw new HaltException (status, body);</span>
    }

    /*
     * TODO Implement these methods!
     */
<span class="nc" id="L530">    public void pass () {}</span>
<span class="nc" id="L531">    public void template (final String template, final Object params) {}</span>
<span class="nc" id="L532">    public void template (final String template, final String layout, final Object params) {}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>