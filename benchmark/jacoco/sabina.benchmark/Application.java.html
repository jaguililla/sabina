<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Application.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">benchmark</a> &gt; <a href="index.source.html" class="el_package">sabina.benchmark</a> &gt; <span class="el_source">Application.java</span></div><h1>Application.java</h1><pre class="source lang-java linenums">/*
 * Copyright © 2015 Juan José Aguililla. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the
 * License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied. See the License for the specific language governing permissions
 * and limitations under the License.
 */

package sabina.benchmark;

import static java.lang.Integer.parseInt;
import static java.lang.System.getProperty;
import static sabina.Sabina.*;
import static sabina.content.JsonContent.toJson;
import static sabina.view.MustacheView.renderMustache;

import com.mchange.v2.c3p0.ComboPooledDataSource;
import sabina.Request;

import java.sql.*;
import java.util.*;
import java.util.Date;
import java.util.concurrent.ThreadLocalRandom;

import javax.sql.DataSource;

/**
 * .
 */
<span class="nc" id="L36">final class Application {</span>
    private static final String SETTINGS_RESOURCE = &quot;/server.properties&quot;;
<span class="fc" id="L38">    private static final Properties SETTINGS = loadConfiguration ();</span>

<span class="fc" id="L40">    private static final String JDBC_URL = SETTINGS.getProperty (&quot;mysql.uri&quot;)</span>
<span class="fc" id="L41">        .replace (&quot;${db.host}&quot;, &quot;localhost&quot;); // TODO Move this to Gradle build</span>
<span class="fc" id="L42">    private static final DataSource DATA_SOURCE = createSessionFactory ();</span>
    private static final int DB_ROWS = 10000;

<span class="pc bpc" id="L45" title="1 of 2 branches missed.">    private static final boolean AUTOCOMMIT = getProperty (&quot;sabina.benchmark.autocommit&quot;) != null;</span>
    private static final String SELECT_WORLD = &quot;select * from world where id = ?&quot;;
    private static final String UPDATE_WORLD = &quot;update world set randomNumber = ? where id = ?&quot;;
    private static final String SELECT_FORTUNES = &quot;select * from fortune&quot;;

    private static final String MESSAGE = &quot;Hello, World!&quot;;
    private static final String CONTENT_TYPE_TEXT = &quot;text/plain&quot;;
    private static final String CONTENT_TYPE_JSON = &quot;application/json&quot;;
    private static final String QUERIES_PARAM = &quot;queries&quot;;

    private static Properties loadConfiguration () {
        try {
<span class="fc" id="L57">            Properties settings = new Properties ();</span>
<span class="fc" id="L58">            settings.load (Class.class.getResourceAsStream (SETTINGS_RESOURCE));</span>
<span class="fc" id="L59">            return settings;</span>
        }
<span class="nc" id="L61">        catch (Exception ex) {</span>
<span class="nc" id="L62">            throw new RuntimeException (ex);</span>
        }
    }

    private static DataSource createSessionFactory () {
        try {
<span class="fc" id="L68">            ComboPooledDataSource dataSource = new ComboPooledDataSource ();</span>
<span class="fc" id="L69">            dataSource.setMinPoolSize (32);</span>
<span class="fc" id="L70">            dataSource.setMaxPoolSize (256);</span>
<span class="fc" id="L71">            dataSource.setCheckoutTimeout (1800);</span>
<span class="fc" id="L72">            dataSource.setMaxStatements (50);</span>
<span class="fc" id="L73">            dataSource.setJdbcUrl (JDBC_URL);</span>
<span class="fc" id="L74">            return dataSource;</span>
        }
<span class="nc" id="L76">        catch (Exception ex) {</span>
<span class="nc" id="L77">            throw new RuntimeException (ex);</span>
        }
    }

    private static int getQueries (final Request request) {
        try {
<span class="fc" id="L83">            String parameter = request.queryParams (QUERIES_PARAM);</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">            if (parameter == null)</span>
<span class="fc" id="L85">                return 1;</span>

<span class="fc" id="L87">            int queries = parseInt (parameter);</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">            if (queries &lt; 1)</span>
<span class="fc" id="L89">                return 1;</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">            if (queries &gt; 500)</span>
<span class="fc" id="L91">                return 500;</span>

<span class="fc" id="L93">            return queries;</span>
        }
<span class="fc" id="L95">        catch (NumberFormatException ex) {</span>
<span class="fc" id="L96">            return 1;</span>
        }
    }

    private static Object getJson (Request it) {
<span class="fc" id="L101">        it.response.type (CONTENT_TYPE_JSON);</span>
<span class="fc" id="L102">        return toJson (new Message ());</span>
    }

    private static Object getDb (Request it) {
<span class="fc" id="L106">        final int queries = getQueries (it);</span>
<span class="fc" id="L107">        final World[] worlds = new World[queries];</span>

<span class="pc" id="L109">        try (final Connection con = DATA_SOURCE.getConnection ()) {</span>
<span class="fc" id="L110">            final Random random = ThreadLocalRandom.current ();</span>
<span class="fc" id="L111">            final PreparedStatement stmt = con.prepareStatement (SELECT_WORLD);</span>

<span class="fc bfc" id="L113" title="All 2 branches covered.">            for (int ii = 0; ii &lt; queries; ii++) {</span>
<span class="fc" id="L114">                stmt.setInt (1, random.nextInt (DB_ROWS) + 1);</span>
<span class="fc" id="L115">                final ResultSet rs = stmt.executeQuery ();</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">                while (rs.next ())</span>
<span class="fc" id="L117">                    worlds[ii] = new World (rs.getInt (1), rs.getInt (2));</span>
            }
<span class="pc bpc" id="L119" title="6 of 8 branches missed.">        }</span>
<span class="nc" id="L120">        catch (SQLException e) {</span>
<span class="nc" id="L121">            e.printStackTrace ();</span>
<span class="fc" id="L122">        }</span>

<span class="fc" id="L124">        it.response.type (CONTENT_TYPE_JSON);</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">        return toJson (it.queryParams (QUERIES_PARAM) == null? worlds[0] : worlds);</span>
    }

    private static Object getFortunes (Request it) {
<span class="fc" id="L129">        final List&lt;Fortune&gt; fortunes = new ArrayList&lt;&gt; ();</span>

<span class="pc" id="L131">        try (final Connection con = DATA_SOURCE.getConnection ()) {</span>
<span class="fc" id="L132">            final ResultSet rs = con.prepareStatement (SELECT_FORTUNES).executeQuery ();</span>
<span class="fc bfc" id="L133" title="All 2 branches covered.">            while (rs.next ())</span>
<span class="fc" id="L134">                fortunes.add (new Fortune (rs.getInt (1), rs.getString (2)));</span>
<span class="pc bpc" id="L135" title="6 of 8 branches missed.">        }</span>
<span class="nc" id="L136">        catch (SQLException e) {</span>
<span class="nc" id="L137">            e.printStackTrace ();</span>
<span class="fc" id="L138">        }</span>

<span class="fc" id="L140">        fortunes.add (new Fortune (0, &quot;Additional fortune added at request time.&quot;));</span>
<span class="fc" id="L141">        fortunes.sort ((a, b) -&gt; a.message.compareTo (b.message));</span>

<span class="fc" id="L143">        it.response.type (&quot;text/html; charset=utf-8&quot;);</span>
<span class="fc" id="L144">        return renderMustache (&quot;/fortunes.mustache&quot;, fortunes);</span>
    }

    private static Object getUpdates (Request it) {
<span class="fc" id="L148">        final int queries = getQueries (it);</span>
<span class="fc" id="L149">        final World[] worlds = new World[queries];</span>

<span class="pc" id="L151">        try (final Connection con = DATA_SOURCE.getConnection ()) {</span>
<span class="fc" id="L152">            con.setAutoCommit (AUTOCOMMIT);</span>

<span class="fc" id="L154">            final Random random = ThreadLocalRandom.current ();</span>
<span class="fc" id="L155">            final PreparedStatement stmtSelect = con.prepareStatement (SELECT_WORLD);</span>
<span class="fc" id="L156">            final PreparedStatement stmtUpdate = con.prepareStatement (UPDATE_WORLD);</span>

<span class="fc bfc" id="L158" title="All 2 branches covered.">            for (int ii = 0; ii &lt; queries; ii++) {</span>
<span class="fc" id="L159">                stmtSelect.setInt (1, random.nextInt (DB_ROWS) + 1);</span>
<span class="fc" id="L160">                final ResultSet rs = stmtSelect.executeQuery ();</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">                while (rs.next ()) {</span>
<span class="fc" id="L162">                    worlds[ii] = new World (rs.getInt (1), rs.getInt (2));</span>
<span class="fc" id="L163">                    stmtUpdate.setInt (1, random.nextInt (DB_ROWS) + 1);</span>
<span class="fc" id="L164">                    stmtUpdate.setInt (2, worlds[ii].id);</span>

<span class="pc bpc" id="L166" title="1 of 2 branches missed.">                    if (AUTOCOMMIT) {</span>
<span class="nc" id="L167">                        stmtUpdate.executeUpdate ();</span>
                    }
                    else {
<span class="fc" id="L170">                        stmtUpdate.addBatch ();</span>
                    }
                }
            }

<span class="pc bpc" id="L175" title="1 of 2 branches missed.">            if (!AUTOCOMMIT) {</span>
<span class="fc" id="L176">                int count = 0;</span>
                boolean retrying;

                do {
                    try {
<span class="fc" id="L181">                        stmtUpdate.executeBatch ();</span>
<span class="fc" id="L182">                        retrying = false;</span>
                    }
<span class="fc" id="L184">                    catch (BatchUpdateException e) {</span>
<span class="fc" id="L185">                        retrying = true;</span>
<span class="fc" id="L186">                    }</span>
                }
<span class="pc bpc" id="L188" title="1 of 4 branches missed.">                while (count++ &lt; 10 &amp;&amp; retrying);</span>

<span class="fc" id="L190">                con.commit ();</span>
            }
<span class="pc bpc" id="L192" title="6 of 8 branches missed.">        }</span>
<span class="nc" id="L193">        catch (SQLException e) {</span>
<span class="nc" id="L194">            e.printStackTrace ();</span>
<span class="fc" id="L195">        }</span>

<span class="fc" id="L197">        it.response.type (CONTENT_TYPE_JSON);</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">        return toJson (it.queryParams (QUERIES_PARAM) == null? worlds[0] : worlds);</span>
    }

    private static Object getPlaintext (Request it) {
<span class="fc" id="L202">        it.response.type (CONTENT_TYPE_TEXT);</span>
<span class="fc" id="L203">        return MESSAGE;</span>
    }

    private static void addCommonHeaders (Request it) {
<span class="fc" id="L207">        it.header (&quot;Server&quot;, &quot;Undertow/1.1.2&quot;);</span>
<span class="fc" id="L208">        it.response.raw ().addDateHeader (&quot;Date&quot;, new Date ().getTime ());</span>
<span class="fc" id="L209">    }</span>

    public static void main (String[] args) {
<span class="fc" id="L212">        get (&quot;/json&quot;, Application::getJson);</span>
<span class="fc" id="L213">        get (&quot;/db&quot;, Application::getDb);</span>
<span class="fc" id="L214">        get (&quot;/query&quot;, Application::getDb);</span>
<span class="fc" id="L215">        get (&quot;/fortune&quot;, Application::getFortunes);</span>
<span class="fc" id="L216">        get (&quot;/update&quot;, Application::getUpdates);</span>
<span class="fc" id="L217">        get (&quot;/plaintext&quot;, Application::getPlaintext);</span>
<span class="fc" id="L218">        after (Application::addCommonHeaders);</span>

<span class="fc" id="L220">        host (SETTINGS.getProperty (&quot;web.host&quot;));</span>
<span class="fc" id="L221">        port (SETTINGS.getProperty (&quot;web.port&quot;));</span>
<span class="fc" id="L222">        start ();</span>
<span class="fc" id="L223">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>